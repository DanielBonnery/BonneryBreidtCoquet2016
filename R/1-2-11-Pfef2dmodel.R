#2.3. Pfeffermann second model
model.Pfeffermann.syst2<-function(sampleparam,theta,xi,param){
  calculsintermediairespourjac<-function(y){return(list(
    Sx=sum(y[,1]),
    Sx2=sum(y[,1]^2),
    Syx=sum(y[,1]*y[,2]),
    Sy=sum(y[,2]),
    Sy2=sum(y[,2]^2)))}
  Jacobiane<-function(listeqtes,xi,theta,n){
    Sx<-listeqtes$Sx;
    Sy<-listeqtes$Sy;
    Sx2<-listeqtes$Sx2;
    Sy2<-listeqtes$Sy2;
    Syx<-listeqtes$Syx;
  return(c(
    Sy/theta[3]^2-(theta[2]*Sx)/theta[3]^2-(2*theta[2]*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*theta[3]^2+2*theta[2]^2*xi[3]+2*theta[1]*theta[2]*xi[3]+theta[1]^2*xi[3]+xi[2]*theta[2]+theta[1]*xi[2]+xi[1]+1/2)-(2*theta[1]*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*theta[3]^2+2*theta[2]^2*xi[3]+2*theta[1]*theta[2]*xi[3]+theta[1]^2*xi[3]+xi[2]*theta[2]+theta[1]*xi[2]+xi[1]+1/2)-(xi[2]*n)/(2*xi[5]+xi[4]+xi[3]*theta[3]^2+2*theta[2]^2*xi[3]+2*theta[1]*theta[2]*xi[3]+theta[1]^2*xi[3]+xi[2]*theta[2]+theta[1]*xi[2]+xi[1]+1/2)-(theta[1]*n)/theta[3]^2,
    -(theta[1]*Sx)/theta[3]^2+Syx/theta[3]^2-(theta[2]*Sx2)/theta[3]^2-(4*theta[2]*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*theta[3]^2+2*theta[2]^2*xi[3]+2*theta[1]*theta[2]*xi[3]+theta[1]^2*xi[3]+xi[2]*theta[2]+theta[1]*xi[2]+xi[1]+1/2)-(2*theta[1]*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*theta[3]^2+2*theta[2]^2*xi[3]+2*theta[1]*theta[2]*xi[3]+theta[1]^2*xi[3]+xi[2]*theta[2]+theta[1]*xi[2]+xi[1]+1/2)-(xi[2]*n)/(2*xi[5]+xi[4]+xi[3]*theta[3]^2+2*theta[2]^2*xi[3]+2*theta[1]*theta[2]*xi[3]+theta[1]^2*xi[3]+xi[2]*theta[2]+theta[1]*xi[2]+xi[1]+1/2),
    -(2*theta[1]*Sy)/theta[3]^3+
      (2*theta[1]*theta[2]*Sx)/theta[3]^3-
      (2*theta[2]*Syx)/theta[3]^3+
      Sy2/theta[3]^3+
      (theta[1]^2*n)/theta[3]^3+
      (theta[2]^2*Sx2)/theta[3]^3-
      (2*xi[3]*theta[3]*n)/(2*xi[5]+
        xi[4]+
        xi[3]*theta[3]^2+
        2*theta[2]^2*xi[3]+
        2*theta[1]*theta[2]*xi[3]+
        theta[1]^2*xi[3]+
        xi[2]*theta[2]+
        theta[1]*xi[2]+xi[1]+1/2)-
      n/theta[3]
    ))}
  hessiane<-function(listeqtes,xi,theta,n){
    Sx<-listeqtes$Sx;
    Sy<-listeqtes$Sy;
    Sx2<-listeqtes$Sx2;
    Sy2<-listeqtes$Sy2;
    Syx<-listeqtes$Syx;
    return(matrix(c(           
      -(2*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)+(((2*theta[2]+2*theta[1])*xi[3]+xi[2])^2*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2-n/theta[3]^2,-Sx/theta[3]^2-(2*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)+(((2*theta[2]+2*theta[1])*xi[3]+xi[2])*((4*theta[2]+2*theta[1])*xi[3]+xi[2])*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2,-(2*Sy)/theta[3]^3+(2*theta[2]*Sx)/theta[3]^3+(2*xi[3]*((2*theta[2]+2*theta[1])*xi[3]+xi[2])*theta[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2+(2*theta[1]*n)/theta[3]^3,-Sx/theta[3]^2-(2*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)+(((2*theta[2]+2*theta[1])*xi[3]+xi[2])*((4*theta[2]+2*theta[1])*xi[3]+xi[2])*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2,-Sx2/theta[3]^2-(4*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)+(((4*theta[2]+2*theta[1])*xi[3]+xi[2])^2*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2,(2*theta[1]*Sx)/theta[3]^3-(2*Syx)/theta[3]^3+(2*theta[2]*Sx2)/theta[3]^3+(2*xi[3]*((4*theta[2]+2*theta[1])*xi[3]+xi[2])*theta[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2,-(2*Sy)/theta[3]^3+(2*theta[2]*Sx)/theta[3]^3+(2*xi[3]*((2*theta[2]+2*theta[1])*xi[3]+xi[2])*theta[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2+(2*theta[1]*n)/theta[3]^3,(2*theta[1]*Sx)/theta[3]^3-(2*Syx)/theta[3]^3+(2*theta[2]*Sx2)/theta[3]^3+(2*xi[3]*((4*theta[2]+2*theta[1])*xi[3]+xi[2])*theta[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2,(6*theta[1]*Sy)/theta[3]^4-(6*theta[1]*theta[2]*Sx)/theta[3]^4+(6*theta[2]*Syx)/theta[3]^4-(3*Sy2)/theta[3]^4-(3*theta[2]^2*Sx2)/theta[3]^4-(2*xi[3]*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)+(4*xi[3]^2*theta[3]^2*n)/(2*xi[5]+xi[4]+xi[3]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)+xi[2]*(theta[2]+theta[1])+xi[1]+1/2)^2+n/theta[3]^2-(3*theta[1]^2*n)/theta[3]^4
      ),3,3))}
ll<-function(listeqtes,xi,theta,n){
    Sx<-listeqtes$Sx;
    Sy<-listeqtes$Sy;
    Sx2<-listeqtes$Sx2;
    Sy2<-listeqtes$Sy2;
    Syx<-listeqtes$Syx;
    return(
      (-1)/(2*theta[3]^2)*Sy2-
        theta[1]^2*n/(2*theta[3]^2)+
        (-theta[2]^2)/(2*theta[3]^2)*Sx2+
        theta[1]/(2*theta[3]^2)*2*Sy+
        (-theta[1]*theta[2])/(2*theta[3]^2)*2*Sx+
        theta[2]/(2*theta[3]^2)*2*Syx+
        (-n)*log(xi[1]+xi[2]*(theta[1]+theta[2])+xi[3]*(theta[1]^2+2*theta[1]*theta[2]+2*theta[2]^2+theta[3]^2)+xi[4]+2*xi[5]+1/2)+
        ((-n)*log(theta[3]^2))/2
      )}
  
    rhothetaxi=function(y,xi,theta){
    if(is.vector(y)){rh<-(xi[1]+xi[2]*y[2]+xi[3] * y[2]^2+xi[4]*y[1]+xi[5]*y[1]^2)/
                         (xi[1]+xi[2]*(theta[1]+theta[2])+xi[3]*((theta[1]+theta[2])^2+theta[3]^2)+xi[4]+2*xi[5])}
    if(is.matrix(y)){rh<-(xi[1]+xi[2]*y[,2]+xi[3] * y[,2]^2+xi[4]*y[,1]+xi[5]*y[,1]^2)/
                         (xi[1]+xi[2]*(theta[1]+theta[2])+xi[3]*((theta[1]+theta[2])^2+theta[3]^2)+xi[4]+2*xi[5])}
    return(rh)};
  rho=function(y){rhothetaxi(y,xi,theta)};
  rloiy=function(N){x<-rgamma(N,1,1);return(matrix(c(x,theta[1]+theta[2]*x+theta[3]*rnorm(N)),N,2))};
  logl1prime<-function(y){c((sqrt(2)*theta[3]*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi)*exp(y[1]-(y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2))*(-(y[1]*(y[2]-theta[2]*y[1]^2-theta[1]*y[1])*(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/(sqrt(2)*theta[3]^3*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi))-((xi[2]*(2*theta[2]+2*theta[1])*xi[4]+xi[2])*(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/(sqrt(2)*theta[3]*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)^2*sqrt(pi))))/(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2),
                      (sqrt(2)*theta[3]*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi)*exp(y[1]-(y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2))*(-(y[1]^2*(y[2]-theta[2]*y[1]^2-theta[1]*y[1])*(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/(sqrt(2)*theta[3]^3*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi))-((xi[2]*(4*theta[2]+2*theta[1])*xi[4]+xi[2])*(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/(sqrt(2)*theta[3]*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)^2*sqrt(pi))))/(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2),
                      (sqrt(2)*theta[3]*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi)*exp(y[1]-(y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2))*(-((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2*(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/(sqrt(2)*theta[3]^4*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi))-((xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/(sqrt(2)*theta[3]^2*(2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)*sqrt(pi))-(sqrt(2)*xi[2]*xi[4]*(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2)*exp((y[2]-theta[2]*y[1]^2-theta[1]*y[1])^2/(2*theta[3]^2)-y[1]))/((2*xi[5]+xi[2]*(theta[3]^2+2*theta[2]^2+2*theta[1]*theta[2]+theta[1]^2)*xi[4]+xi[2]*(theta[2]+theta[1]+1/2)+xi[1]+1/2)^2*sqrt(pi))))/(xi[3]*y[2]^2+xi[2]*y[2]+xi[5]*y[1]^2+xi[4]*y[1]+xi[1]+1/2))};
  return(list(
  rloiy=rloiy,
  ploi=function(y){
    if(is.vector(y)){p<-pnorm(y[2]-theta[1]-theta[2]*y[1],sd=theta[3])}
    if(is.matrix(y)){p<-pnorm(y[,2]-theta[1]-theta[,2]*y[,1])}
    return(p)
    }, ploilim=function(y){
    if(is.vector(y)){p<-pnorm(y[2]-theta[1]-theta[2]*y[1],sd=theta[3])}
    if(is.matrix(y)){p<-pnorm(y[,2]-theta[1]-theta[,2]*y[,1])}
    return(p)},
  rloiz=function(y){
    if(is.vector(y)){r<-y[2]*(y[2]>xi)}
    if(is.matrix(y)){r<-y[,2]*(y[,2]>xi)}
    return(r)},
  dloi=function(y){
    if(is.vector(y)){d<-dnorm(y[2]-theta[1]-theta[2]*y[1],sd=theta[3])}
    if(is.matrix(y)){d<-dnorm(y[,2]-theta[1]-theta[2]*y[,1],sd=theta[3])}
    return(d)},
  dloitheta=function(y,theta){
    if(is.vector(y)){d<-dnorm(y[2]-theta[1]-theta[2]*y[1],sd=theta[3])}
    if(is.matrix(y)){d<-dnorm(y[,2]-theta[1]-theta[2]*y[,1],sd=theta[3])}
    return(d)},
  Scheme=SystematicPPS(sampleparam),
  rho=rho,
  rhothetaxi=rhothetaxi,
  hessiane=hessiane,
  Jacobiane=Jacobiane,
  ll=ll,
  calculsintermediairespourjac=calculsintermediairespourjac,
  vinf=function(y){sampleparam$tau*y},
  En=function(N){sampleparam$tau*N},
  xi=xi,theta=theta,param=param,
  sampleparam=sampleparam,
  logl1prime=logl1prime,
  I11=function(){yyy<-rloiy(1000);lll<-apply(yyy,1,logl1prime)^2*rho(yyy);lll<-lll[,unique(floor((0:2999)[!is.na(lll)]/3)+1)];E.lll<-apply(lll,1,mean,na.rm=TRUE);
                V.lll<-(lll-E.lll)%*%t(lll-E.lll)/(length(lll[1,])*matrix(rep(1,9),3,3)-diag(rep(1,3)));return(V.lll)},
 
  I12=function(){yyy<-rloiy(1000);lll<-apply(yyy,1,logl1prime)^2*rho(yyy);lll<-lll[,unique(floor((0:2999)[!is.na(lll)]/3)+1)];E.lll<-apply(lll,1,mean,na.rm=TRUE);
                V.lll<-(lll-E.lll)%*%t(lll-E.lll)/(length(lll[1,])*matrix(rep(1,9),3,3)-diag(rep(1,3)));return(V.lll)},
  xihat=function(y,z,s){sprime<-unique(s);return(as.vector(lm(z[sprime]~cbind(y[sprime,2],y[sprime,2]^2,y[sprime,1],y[sprime,1]^2),weights=1/SystematicPPS(sampleparam)$Pik(z)[sprime])$coefficients))},
  thetaht=function(y,z,s){sprime<-unique(s);piks<-SystematicPPS(sampleparam)$Pik(z)[sprime];lmm<-lm(y[sprime,2]~cbind(y[sprime,1]),weights=1/piks);
                          sigmahat<-sum(lmm$residuals^2/piks)/sum(1/piks)
                          return(c(as.vector(lmm$coefficients),sigmahat))},
  thetaniais=function(y,z,s){lmm<-lm(y[,2]~cbind(y[,1]));
                          sigmahat<-mean(lmm$residuals^2)
                          return(c(as.vector(lmm$coefficients),sigmahat))},
  thetahat=function(y,z,s){},
  supportY=c(-.1,2.1)))}
#"test :"; sampleparam<-list(tau=0.5);theta<-c(1,2,3);xi<-c(1,2,3,4,5);m<-model.Pfeffermann.syst2(sampleparam,theta,xi);m$Scheme$S(2:24);
#N<-1500;y<-m$rloiy(N);z<-m$rloiz(y);s<-m$Scheme$S(z);m$xihat(y,z,s);m$thetaht(y,z,s)